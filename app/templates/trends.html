{% extends "base.html" %}
{% block content %}

<section class="section">
  <div class="section-head">
    <div>
      <div class="pill">INSIGHTS</div>
      <h2>Trends (Weight & BMI)</h2>
      <p class="sub">Visualise weight and BMI trends for the last {{ n }} records.</p>
    </div>

    <div class="actions">
      <a class="btn {{ 'primary' if n==7 else '' }}" href="/trends?n=7">Last 7</a>
      <a class="btn {{ 'primary' if n==30 else '' }}" href="/trends?n=30">Last 30</a>
    </div>
  </div>

  {% if not records %}
    <div class="card"><p class="muted">No data yet. Please add some records in "Record".</p></div>
  {% else %}
    <div class="card">
      <div id="trend-chart" style="width:100%; height:420px;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
      const dates = [
        {% for r in records %}
          "{{ r.date }}"{% if not loop.last %}, {% endif %}
        {% endfor %}
      ];

      const weights = [
        {% for r in records %}
          {{ "%.1f"|format(r.weight_kg) }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      ];

      const bmis = [
        {% for r in records %}
          {% if r.bmi is not none %}
            {{ "%.1f"|format(r.bmi) }}
          {% else %}
            null
          {% endif %}
          {% if not loop.last %}, {% endif %}
        {% endfor %}
      ];

      const chartDom = document.getElementById('trend-chart');
      const myChart = echarts.init(chartDom);

      const option = {
        tooltip: { trigger: 'axis' },
        legend: { data: ['Weight (kg)', 'BMI'] },
        xAxis: { type: 'category', data: dates },
        yAxis: [
          { type: 'value', name: 'Weight (kg)' },
          { type: 'value', name: 'BMI' }
        ],
        series: [
          { name: 'Weight (kg)', type: 'line', smooth: true, yAxisIndex: 0, data: weights },
          { name: 'BMI', type: 'line', smooth: true, yAxisIndex: 1, data: bmis }
        ]
      };

      myChart.setOption(option);
      window.addEventListener('resize', () => myChart.resize());
    </script>
  {% endif %}
</section>

{% endblock %}
